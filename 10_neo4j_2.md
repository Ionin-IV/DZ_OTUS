# Домашнее задание по лекции "Использование neo4j"

## Задание

1. Взять 4-5 популярных туроператора.
2. Каждый туроператор должен быть представлен в виде ноды neo4j
3. Взять 10-15 направлений, в которые данные операторы предосавляют путевки.
4. Представить направления в виде связки нод: страна - конкретное место
5. Взять ближайшие к туриситческим локацимя города, в которых есть аэропорты или вокзалы и представить их в виде нод
6. Представить маршруты между городми в виде связей. Каждый маршрут должен быть охарактеризован видом транспорта, который позволяет переместиться между точками.
7. Написать запрос, который бы выводил направление (со всеми промежуточными точками), который можно осуществить только наземным транспортом.
8. Составить план запроса из пункта 7.
9. Добавить индексы для оптимизации запроса
10. Еще раз посмотреть план запроса и убедиться, что индексыпозволили оптимизировать запрос

## Выполнение задания

1. Создаю туроператоров:

```
create (:Operator {name:'ANEX Tour'})
create (:Operator {name:'Pegas Touristic'})
create (:Operator {name:'Tez Tour'})
create (:Operator {name:'Coral Travel'})
```

2. Создаю страны:

```
create (:Country {name:'Турция'})
create (:Country {name:'Таиланд'})
create (:Country {name:'Доминикана'})
create (:Country {name:'Египет'})
create (:Country {name:'Китай'})
create (:Country {name:'ОАЭ'})
create (:Country {name:'Россия'})
```

3. Создаю места отдыха:

```
create (:Place {name:'Кемер'})
create (:Place {name:'Анталья'})
create (:Place {name:'Паттайя'})
create (:Place {name:'Пхукет'})
create (:Place {name:'Бока-Чика'})
create (:Place {name:'Хургада'})
create (:Place {name:'Шарм-эль-Шейх'})
create (:Place {name:'Хайнань'})
create (:Place {name:'Дубай'})
create (:Place {name:'Анапа'})
create (:Place {name:'Геленджик'})
create (:Place {name:'Казань'})
```

4. Создаю туры цепочкой: (Оператор) - [Тур] -> (Страна) - [Расположение] -> (Место отдыха). Для правильной связки оператора с местом отдыха, задаю идентификатор тура tour_id в связях "Тур" и "Расположение", иначе, при запросе туров, будут выбираться цепочки связей всех операторов, кторые связаны с данной страной.

```
match (o1:Operator {name:'ANEX Tour'})
match (o2:Operator {name:'Pegas Touristic'})
match (o3:Operator {name:'Tez Tour'})
match (o4:Operator {name:'Coral Travel'})
match (с1:Country {name:'Турция'})
match (с2:Country {name:'Таиланд'})
match (с3:Country {name:'Доминикана'})
match (с4:Country {name:'Египет'})
match (с5:Country {name:'Китай'})
match (с6:Country {name:'ОАЭ'})
match (с7:Country {name:'Россия'})
match (p1:Place {name:'Кемер'})
match (p2:Place {name:'Анталья'})
match (p3:Place {name:'Паттайя'})
match (p4:Place {name:'Пхукет'})
match (p5:Place {name:'Бока-Чика'})
match (p6:Place {name:'Хургада'})
match (p7:Place {name:'Шарм-эль-Шейх'})
match (p8:Place {name:'Хайнань'})
match (p9:Place {name:'Дубай'})
match (p10:Place {name:'Анапа'})
match (p11:Place {name:'Геленджик'})
match (p12:Place {name:'Казань'})
create (o1) - [:TOUR {tour_id:1}] -> (с1) - [:PLACE_IN {tour_id:1}] -> (p1)
create (o2) - [:TOUR {tour_id:2}] -> (с1) - [:PLACE_IN {tour_id:2}] -> (p2)
create (o3) - [:TOUR {tour_id:3}] -> (с2) - [:PLACE_IN {tour_id:3}] -> (p3)
create (o4) - [:TOUR {tour_id:4}] -> (с2) - [:PLACE_IN {tour_id:4}] -> (p4)
create (o1) - [:TOUR {tour_id:5}] -> (с3) - [:PLACE_IN {tour_id:5}] -> (p5)
create (o3) - [:TOUR {tour_id:6}] -> (с4) - [:PLACE_IN {tour_id:6}] -> (p6)
create (o4) - [:TOUR {tour_id:7}] -> (с4) - [:PLACE_IN {tour_id:7}] -> (p7)
create (o2) - [:TOUR {tour_id:8}] -> (с5) - [:PLACE_IN {tour_id:8}] -> (p8)
create (o4) - [:TOUR {tour_id:9}] -> (с6) - [:PLACE_IN {tour_id:9}] -> (p9)
create (o1) - [:TOUR {tour_id:10}] -> (с7) - [:PLACE_IN {tour_id:10}] -> (p10)
create (o2) - [:TOUR {tour_id:11}] -> (с7) - [:PLACE_IN {tour_id:11}] -> (p11)
create (o3) - [:TOUR {tour_id:12}] -> (с7) - [:PLACE_IN {tour_id:12}] -> (p12)
```

5. Создаю ближайшие к месту отдыха города с аэропортами прилёта в страну:

```
create (:City {name:'Анталья'})
create (:City {name:'Районг'})
create (:City {name:'Пхукет'})
create (:City {name:'Пунта-Кауседо'})
create (:City {name:'Хургада'})
create (:City {name:'Шарм-эль-Шейх'})
create (:City {name:'Хайкоу'})
create (:City {name:'Дубай'})
create (:City {name:'Анапа'})
create (:City {name:'Геленджик'})
create (:City {name:'Казань'})
```

6. Создаю связки городов и мест отдыха, задав параметром связки вид транспорта, кторым можно добраться из аэропорта к месту отдыха:

```
match (p1:Place {name:'Кемер'})
match (p2:Place {name:'Анталья'})
match (p3:Place {name:'Паттайя'})
match (p4:Place {name:'Пхукет'})
match (p5:Place {name:'Бока-Чика'})
match (p6:Place {name:'Хургада'})
match (p7:Place {name:'Шарм-эль-Шейх'})
match (p8:Place {name:'Хайнань'})
match (p9:Place {name:'Дубай'})
match (p10:Place {name:'Анапа'})
match (p11:Place {name:'Геленджик'})
match (p12:Place {name:'Казань'})
match (t1:City {name:'Анталья'})
match (t2:City {name:'Районг'})
match (t3:City {name:'Пхукет'})
match (t4:City {name:'Пунта-Кауседо'})
match (t5:City {name:'Хургада'})
match (t6:City {name:'Шарм-эль-Шейх'})
match (t7:City {name:'Хайкоу'})
match (t8:City {name:'Дубай'})
match (t9:City {name:'Анапа'})
match (t10:City {name:'Геленджик'})
match (t11:City {name:'Казань'})
create (p1) <- [:TRANSPORT {type:'Auto'}] - (t1)
create (p2) <- [:TRANSPORT {type:'Auto'}] - (t1)
create (p3) <- [:TRANSPORT {type:'Auto'}] - (t2)
create (p4) <- [:TRANSPORT {type:'Auto'}] - (t3)
create (p5) <- [:TRANSPORT {type:'Auto'}] - (t4)
create (p6) <- [:TRANSPORT {type:'Auto'}] - (t5)
create (p7) <- [:TRANSPORT {type:'Auto'}] - (t6)
create (p8) <- [:TRANSPORT {type:'Auto'}] - (t7)
create (p8) <- [:TRANSPORT {type:'Train'}] - (t7)
create (p9) <- [:TRANSPORT {type:'Auto'}] - (t8)
create (p10) <- [:TRANSPORT {type:'Auto'}] - (t9)
create (p10) <- [:TRANSPORT {type:'Train'}] - (t9)
create (p11) <- [:TRANSPORT {type:'Auto'}] - (t10)
create (p12) <- [:TRANSPORT {type:'Auto'}] - (t11)
create (p12) <- [:TRANSPORT {type:'Train'}] - (t11)
```

7. Запрашиваю полный список созданных туров (если в турах есть несколько видов транспорта из аэропорта к месту отдыха, то они выводятся разными строками):

```
╒═════════════════════════════════════╤═════════════════════╤═══════════════════════════════╤═════════════════════════╤════════════════════════════════╤════════════════════════════╤═══════════════════════════════╕
│n0                                   │r0                   │n1                             │r1                       │n2                              │r2                          │n3                             │
╞═════════════════════════════════════╪═════════════════════╪═══════════════════════════════╪═════════════════════════╪════════════════════════════════╪════════════════════════════╪═══════════════════════════════╡
│(:Operator {name: "Pegas Touristic"})│[:TOUR {tour_id: 2}] │(:Country {name: "Турция"})    │[:PLACE_IN {tour_id: 2}] │(:Place {name: "Анталья"})      │[:TRANSPORT {type: "Auto"}] │(:City {name: "Анталья"})      │
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────┼─────────────────────────┼────────────────────────────────┼────────────────────────────┼───────────────────────────────┤
│(:Operator {name: "ANEX Tour"})      │[:TOUR {tour_id: 1}] │(:Country {name: "Турция"})    │[:PLACE_IN {tour_id: 1}] │(:Place {name: "Кемер"})        │[:TRANSPORT {type: "Auto"}] │(:City {name: "Анталья"})      │
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────┼─────────────────────────┼────────────────────────────────┼────────────────────────────┼───────────────────────────────┤
│(:Operator {name: "Coral Travel"})   │[:TOUR {tour_id: 4}] │(:Country {name: "Таиланд"})   │[:PLACE_IN {tour_id: 4}] │(:Place {name: "Пхукет"})       │[:TRANSPORT {type: "Auto"}] │(:City {name: "Пхукет"})       │
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────┼─────────────────────────┼────────────────────────────────┼────────────────────────────┼───────────────────────────────┤
│(:Operator {name: "Tez Tour"})       │[:TOUR {tour_id: 3}] │(:Country {name: "Таиланд"})   │[:PLACE_IN {tour_id: 3}] │(:Place {name: "Паттайя"})      │[:TRANSPORT {type: "Auto"}] │(:City {name: "Районг"})       │
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────┼─────────────────────────┼────────────────────────────────┼────────────────────────────┼───────────────────────────────┤
│(:Operator {name: "ANEX Tour"})      │[:TOUR {tour_id: 5}] │(:Country {name: "Доминикана"})│[:PLACE_IN {tour_id: 5}] │(:Place {name: "Бока-Чика"})    │[:TRANSPORT {type: "Auto"}] │(:City {name: "Пунта-Кауседо"})│
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────┼─────────────────────────┼────────────────────────────────┼────────────────────────────┼───────────────────────────────┤
│(:Operator {name: "Coral Travel"})   │[:TOUR {tour_id: 7}] │(:Country {name: "Египет"})    │[:PLACE_IN {tour_id: 7}] │(:Place {name: "Шарм-эль-Шейх"})│[:TRANSPORT {type: "Auto"}] │(:City {name: "Шарм-эль-Шейх"})│
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────┼─────────────────────────┼────────────────────────────────┼────────────────────────────┼───────────────────────────────┤
│(:Operator {name: "Tez Tour"})       │[:TOUR {tour_id: 6}] │(:Country {name: "Египет"})    │[:PLACE_IN {tour_id: 6}] │(:Place {name: "Хургада"})      │[:TRANSPORT {type: "Auto"}] │(:City {name: "Хургада"})      │
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────┼─────────────────────────┼────────────────────────────────┼────────────────────────────┼───────────────────────────────┤
│(:Operator {name: "Pegas Touristic"})│[:TOUR {tour_id: 8}] │(:Country {name: "Китай"})     │[:PLACE_IN {tour_id: 8}] │(:Place {name: "Хайнань"})      │[:TRANSPORT {type: "Train"}]│(:City {name: "Хайкоу"})       │
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────┼─────────────────────────┼────────────────────────────────┼────────────────────────────┼───────────────────────────────┤
│(:Operator {name: "Pegas Touristic"})│[:TOUR {tour_id: 8}] │(:Country {name: "Китай"})     │[:PLACE_IN {tour_id: 8}] │(:Place {name: "Хайнань"})      │[:TRANSPORT {type: "Auto"}] │(:City {name: "Хайкоу"})       │
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────┼─────────────────────────┼────────────────────────────────┼────────────────────────────┼───────────────────────────────┤
│(:Operator {name: "Coral Travel"})   │[:TOUR {tour_id: 9}] │(:Country {name: "ОАЭ"})       │[:PLACE_IN {tour_id: 9}] │(:Place {name: "Дубай"})        │[:TRANSPORT {type: "Auto"}] │(:City {name: "Дубай"})        │
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────┼─────────────────────────┼────────────────────────────────┼────────────────────────────┼───────────────────────────────┤
│(:Operator {name: "Tez Tour"})       │[:TOUR {tour_id: 12}]│(:Country {name: "Россия"})    │[:PLACE_IN {tour_id: 12}]│(:Place {name: "Казань"})       │[:TRANSPORT {type: "Train"}]│(:City {name: "Казань"})       │
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────┼─────────────────────────┼────────────────────────────────┼────────────────────────────┼───────────────────────────────┤
│(:Operator {name: "Tez Tour"})       │[:TOUR {tour_id: 12}]│(:Country {name: "Россия"})    │[:PLACE_IN {tour_id: 12}]│(:Place {name: "Казань"})       │[:TRANSPORT {type: "Auto"}] │(:City {name: "Казань"})       │
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────┼─────────────────────────┼────────────────────────────────┼────────────────────────────┼───────────────────────────────┤
│(:Operator {name: "Pegas Touristic"})│[:TOUR {tour_id: 11}]│(:Country {name: "Россия"})    │[:PLACE_IN {tour_id: 11}]│(:Place {name: "Геленджик"})    │[:TRANSPORT {type: "Auto"}] │(:City {name: "Геленджик"})    │
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────┼─────────────────────────┼────────────────────────────────┼────────────────────────────┼───────────────────────────────┤
│(:Operator {name: "ANEX Tour"})      │[:TOUR {tour_id: 10}]│(:Country {name: "Россия"})    │[:PLACE_IN {tour_id: 10}]│(:Place {name: "Анапа"})        │[:TRANSPORT {type: "Auto"}] │(:City {name: "Анапа"})        │
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────┼─────────────────────────┼────────────────────────────────┼────────────────────────────┼───────────────────────────────┤
│(:Operator {name: "ANEX Tour"})      │[:TOUR {tour_id: 10}]│(:Country {name: "Россия"})    │[:PLACE_IN {tour_id: 10}]│(:Place {name: "Анапа"})        │[:TRANSPORT {type: "Train"}]│(:City {name: "Анапа"})        │
└─────────────────────────────────────┴─────────────────────┴───────────────────────────────┴─────────────────────────┴────────────────────────────────┴────────────────────────────┴───────────────────────────────┘
```

8. Запрашиваю туры, в которых есть перемещение из аэропорта к месту отдыха по железной дороге (отступил от задания, т.к. в моих данных нет авиаперелётов из города к месту отдыха):

Команда:
```
profile
match (n0:Operator) -[r0:TOUR]- (n1:Country) -[r1:PLACE_IN]- (n2:Place) -[r2:TRANSPORT {type:'Train'}]- (n3:City)
where r0.tour_id = r1.tour_id
return  n0, r0, n1, r1, n2, r2, n3
```

Полученные данные:
```
╒═════════════════════════════════════╤═════════════════════╤═══════════════════════════╤═════════════════════════╤══════════════════════════╤════════════════════════════╤════════════════════════╕
│n0                                   │r0                   │n1                         │r1                       │n2                        │r2                          │n3                      │
╞═════════════════════════════════════╪═════════════════════╪═══════════════════════════╪═════════════════════════╪══════════════════════════╪════════════════════════════╪════════════════════════╡
│(:Operator {name: "Tez Tour"})       │[:TOUR {tour_id: 12}]│(:Country {name: "Россия"})│[:PLACE_IN {tour_id: 12}]│(:Place {name: "Казань"}) │[:TRANSPORT {type: "Train"}]│(:City {name: "Казань"})│
├─────────────────────────────────────┼─────────────────────┼───────────────────────────┼─────────────────────────┼──────────────────────────┼────────────────────────────┼────────────────────────┤
│(:Operator {name: "Pegas Touristic"})│[:TOUR {tour_id: 8}] │(:Country {name: "Китай"}) │[:PLACE_IN {tour_id: 8}] │(:Place {name: "Хайнань"})│[:TRANSPORT {type: "Train"}]│(:City {name: "Хайкоу"})│
├─────────────────────────────────────┼─────────────────────┼───────────────────────────┼─────────────────────────┼──────────────────────────┼────────────────────────────┼────────────────────────┤
│(:Operator {name: "ANEX Tour"})      │[:TOUR {tour_id: 10}]│(:Country {name: "Россия"})│[:PLACE_IN {tour_id: 10}]│(:Place {name: "Анапа"})  │[:TRANSPORT {type: "Train"}]│(:City {name: "Анапа"}) │
└─────────────────────────────────────┴─────────────────────┴───────────────────────────┴─────────────────────────┴──────────────────────────┴────────────────────────────┴────────────────────────┘
```

Данные profile по выполненному запросу:
```
Cypher version: 5, planner: COST, runtime: SLOTTED. 140 total db hits in 55 ms
```

__Результат:__ 140 обращений к БД за 55 мс.

9. Создаю индекс по виду транспорта:

```
CREATE INDEX transport_index FOR ()-[r:TRANSPORT]-() ON r.type
```

10. Опять запрашиваю туры, в которых есть перемещение из аэропорта к месту отдыха по железной дороге (т.к. данных мало, и СУБД быстрее пройти данные сканом, чем использовать индекс, то пришлось применить хинт, явно указывающий на индекс):

Команда:
```
profile
match (n0:Operator) -[r0:TOUR]- (n1:Country) -[r1:PLACE_IN]- (n2:Place) -[r2:TRANSPORT {type:'Train'}]- (n3:City)
using index r2:TRANSPORT(type)
where r0.tour_id = r1.tour_id
return  n0, r0, n1, r1, n2, r2, n3
```

Данные profile по выполненному запросу:
```
Cypher version: 5, planner: COST, runtime: SLOTTED. 94 total db hits in 46 ms
```

__Результат:__ обращения к БД сократились со 140 до 94. На большем количестве данных должно быть ощутимое улучшение производительности.
